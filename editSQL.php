<?php ob_start();session_start();strpos(($_SERVER['HTTP_REFERER']??''),basename(__FILE__))?'':session_unset()&&session_destroy();function r(){header("Location: /");}$f=$_GET['f']??''?:r();if(!($_SESSION['l']??0)){if(!isset($_POST['p'])){echo"<form method=post>$f<input type=password name=p required>";exit;}($_POST['p']??'')=='admin'?$_SESSION['l']=1:r();}try{$db=new PDO("sqlite:$f");$db->setAttribute(3,2);}catch(Exception$e){r();}$T=$db->query("SELECT name FROM sqlite_master WHERE type='table'")->fetchAll(7);function tb($r,$n){if($r){echo"<b>$n</b><hr><div style=max-height:400px;overflow:auto><table border=1><tr><th>".join("</th><th>",array_keys($r[0]))."</th></tr>";foreach($r as$v)echo"<tr><td>".join("</td><td>",$v)."</td></tr>";echo"</table></div>";}}if(($t=$_GET['x']??'')&&in_array($t,$T)){$d=$db->query("SELECT*FROM $t")->fetchAll(2);$j=($_GET['y']??'')=='j';header('Content-Type:'.($j?'application/json':'text/csv'));header("Content-Disposition:attachment;filename=$t.".($j?"json":"csv"));$j?print(json_encode($d,448|256)):($o=fopen('php://output','w'))&&fputcsv($o,array_keys($d[0]??[]))||array_map(fn($r)=>fputcsv($o,$r),$d);exit;}foreach($T as$t)if($t!='sqlite_sequence')echo"<a href=?f=$f&t=$t>$t</a><hr>";if(($t=$_GET['t']??($_SESSION['lb']??''))&&in_array($t,$T)){try{$r=$db->query("SELECT*FROM $t")->fetchAll(2);tb($r?:$db->query("PRAGMA table_info($t)")->fetchAll(2),$t);echo"<hr><a href=?f=$f&x=$t&y=j>JSON</a>|<a href=?f=$f&x=$t&y=c>CSV</a>";}catch(Exception$e){echo$e->getMessage();}}if(!empty($_POST['c'])){$_SESSION['c']=$q=$_POST['c'];$e='';try{if(($s=$db->query($q))instanceof PDOStatement&&preg_match('/^(INSERT|UPDATE|DELETE)\s+(?:INTO|FROM)?\s*["`]?(?<t>[a-z0-9_]+)["`]?/i',$q,$m))$_SESSION['lb']=$m[2];$_SESSION['h'][]=$q;}catch(Exception$x){$e=$x->getMessage();}$e?print("<br>$e"):header("Location: ?f=$f&run=1");}isset($_GET['z'])&&$_SESSION['c']='';?><form method=post onsubmit="return s()"><textarea name=c id=c rows=10 cols=50 required><?=htmlspecialchars($_SESSION['c']??'')?></textarea><br><input type=hidden name=f value="<?=$f?>"><input type=submit> <a href="?f=<?=$f?>&z=1">Clear</a></form><script>function s(){let c=document.querySelector('#c').value.toUpperCase();return['DROP','DELETE','VACUUM','TRUNCATE','UPDATE','REPLACE','ALTER','ATTACH','DETACH'].some(x=>c.includes(x))?confirm(c):1;}</script><textarea readonly rows=10 cols=50><?php echo!empty($_SESSION['h'])?join("\n\n",array_slice(array_reverse($_SESSION['h']),-500)):'';ob_end_flush();?></textarea>
